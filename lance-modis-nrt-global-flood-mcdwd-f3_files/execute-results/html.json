{
  "hash": "57edd47992157c897341391160f4476e",
  "result": {
    "markdown": "---\ntitle: \"MODIS NRT Global Flood Product\"\nauthor: \"Juan F. Martinez, Iris Cano\"\ndate: \"January 30, 2024\"\nbibliography: nrt-flood-references.bib\n---\n\n\n# LANCE MODIS Near Real Time (NRT) Global Flood Product\n\n<img src=\"https://www.earthdata.nasa.gov/sites/default/files/imported/Flood_mekong.png\" alt=\"MODIS NRT FLOOD\"/>[^1]\n\n[^1]: Photo Credit, NASA OESDIS.\n\n## Overview\n\nIn this lesson, you will use R to take a closer look at the data from the LANCE MODIS Near Real Time (NRT) Global Flood Product, including learning about what are LANCE and MODIS, and the NRT Flood products available. You will then learn to select, download, and visualize one of the NRT Flood layers.\n\n::: {.column-margin}\n::: {.callout-tip style=\"color: #5a7a2b;\"}\n## Coding Review\nThis lesson uses the [R](https://www.r-project.org/about.html) language and environment. R is a popular language used for statistical computing and graphics.\n:::\n:::\n\n## Learning Objectives\n\nAfter completing this lesson, you should be able to:\n\n-   Determine what NRT raster data is available by navigating the LANCE website.\n\n-   Read a tile map and select a raster tile to download based on a point of interest.\n\n-   Download near-real-time raster data using the application programming interfaces (APIs) with the GET HTTP request method [@wilsjame].\n\n-   View the downloaded raster data to quickly preview.\n\n-   Classify and place on a map the NRT flood raster data to determine areas with unusual flooding.\n\n## Introduction\n\nThe **MODIS/Aqua+Terra Global Flood Product L3 Near Real Time (NRT) 250m Global Flood Product (MCDWD_L3_NRT) (beta)** provides daily maps of flooding globally. The product is provided over 3 compositing periods (1-day, 2-day, and 3-day) to minimize the impact of clouds and more rigorously identify flood water (the best composite will depend on the cloudiness for a particular event) [@lin2019]\n\n## What are MODIS and LANCE?\n\n### MODIS\n\nThe Moderate Resolution Imaging Spectroradiometer (MODIS) is a NASA Earth Observing System (EOS) satellite-based sensor system that creates data products including land surface temperatures, land surface reflectance, radiances, clouds, aerosols, water vapor, active fire, snow cover, sea ice measurements, and other factor information. The MODIS Near Real-Time (NRT) data includes the Flood product which is a daily \\~250 m resolution product showing flood and surface water detected from the twice-daily overpass of the MODIS optical sensors.\n\nThe satellite data is readily available shortly after it is acquired by the MODIS instrument on board the Terra and Aqua satellites. This space-based instrument distinguishes 36 spectral bands and groups of wavelengths which helps map the extent of snow and ice caused by winter storms and frigid temperatures. Initially, the water-detecting algorithm is applied to both MODIS observations (Terra and Aqua). Due to cloud and terrain shadows create false positives.\n\n<img src=\"https://modis.gsfc.nasa.gov/about/images/modisComponents.jpg\" alt=\"MODIS Components\"/>[^2]\n\n[^2]: Photo Credit, NASA GSFC.\n\nTo minimize errors, the product is generated with three different ***compositing periods (1-day, 2-day, and 3-day)*** to compare results and decide which product has better coverage for the event. Further, they have to differentiate floods from expected surface water through the use of MODIS Land Water Mask (MOD44W), which uses a decision tree classifier trained with MODIS data to produce a global water mask [@carroll2016].\n\nMODIS adoption aimed to surpass barriers related to satellite data, including cost, delivery timelines, limited formats, and the need for technical expertise. The transition to GFIMS establishes an operational system at FAO, ensuring continuity in meeting NASA data-user needs [@lin2019].\n\n### LANCE\n\nThe **Land, Atmosphere Near Real-time Capability for EOS (LANCE)** is a NASA initiative that provides near real-time access to satellite data, including MODIS. It allows users to access the latest data within a few hours of satellite overpass, enabling rapid responses to environmental events such as floods. LANCE is particularly valuable for emergency response teams and researchers who require up-to-date information for monitoring and assessing natural disasters [@LANCE2024].\n\nLANCE reduces processing time, allowing for timely computation. Users access the data through platforms like Web Map Service (WMS) and Web Coverage Service (WCS), enabling visualization and analysis for informed decision-making. This NRT approach enhances the speed and accessibility of critical information on vegetation conditions [@zhang2022].\n\n### MODIS NRT Flood MCDWD Data Products\n\n::: {.column-margin}\n::: {.callout-tip style=\"color: #5a7a2b;\"}\n## Data Information \nThe main landing pages for the MODIS NRT Global Flood Product:\n\n[NASA EARTHDATA](https://www.earthdata.nasa.gov/learn/find-data/near-real-time/modis-nrt-global-flood-product)\n\n[NASA CRM SEARCH](https://cmr.earthdata.nasa.gov/search/concepts/C2018599131-LANCEMODIS.html)\n\n[MODIS NRT Global Flood Product User Guide](https://www.earthdata.nasa.gov/s3fs-public/2023-01/MCDWD_UserGuide_RevC.pdf)\n:::\n:::\n\nThe ***MODIS/Terra+Aqua Combined MODIS Water Detection (MCDWD)*** algorithm is tailor-made for detecting water bodies using MODIS data obtained from both the Terra and Aqua satellites. This algorithm employs various bands and spectral information to effectively identify and categorize water bodies. This enhances the accuracy and reliability of the flood product generated [@slayback2023].\n\nThe MODIS Near Real-Time (NRT) Flood dataset offers multiple products, each accompanied by corresponding layers. The specific layers depend on the temporal aggregation:\n\n***MCDWD_F1_L3_NRT (1-Day product)*** This product type is the most basic level and provides binary information about water occurrence. Pixels are classified as either containing water or not, offering a simple way to identify flooded areas.\n\n***MCDWD_F1CS_L3_NRT (1-Day CS)***: F1CS has a cloud shadow mask applied on the version of the MCDWD_F1_L3_NRT product\n\n***MCDWD_F2_L3_NRT (2-Day)***: F2 provides additional information by categorizing water occurrences into three categories: no water, low-confidence water, and high-confidence water. This classification allows for a more nuanced understanding of the extent of the flood and its associated confidence levels.\n\n***MCDWD_F3_L3_NRT (3-Day)***: The F3 product, based on the MCDWD (MODIS/Terra+Aqua Combined MODIS Water Detection) is an algorithm that further refines flood mapping by adding additional spectral information. These results create a more accurate representation of water bodies and flooded areas [@slayback2023].\n\n## Reading the Data\n\nFor this exercise, we will be using the MCDWD L3 F3 product: [LANCE NRT Flood](https://nrt3.modaps.eosdis.nasa.gov/archive/allData/61/MCDWD_L3_F3_NRT/)\n\nFirst, install and load the R packages required for this exercise:\n\n\n::: {.cell}\n\n```{.r .cell-code}\npackages_to_check <- c(\"stars\", \"httr\", \"jsonlite\", \"tmap\", \"basemaps\")\n\n# Check and install packages\nfor (package_name in packages_to_check) {\n  if (!package_name %in% rownames(installed.packages())) {\n    install.packages(package_name)\n    cat(paste(\"Package\", package_name, \"installed.\\n\"))\n  } else {\n    cat(paste(\"Package\", package_name, \"is already installed.\\n\"))\n  }\n  library(package_name, character.only = TRUE)\n}\n\n#in case tmap does not install\n#remotes::install_github('r-tmap/tmap')\n```\n:::\n\n::: {.column-margin}\n::: {.callout-tip style=\"color: #5a7a2b;\"}\n## Coding Review\n\nThis lesson uses the [stars](https://r-spatial.github.io/stars/), [httr](https://httr.r-lib.org/), [jsonlite](https://cran.r-project.org/package=jsonlite), [tmap](https://cran.r-project.org/package=tmap), and [basemaps](https://cran.r-project.org/package=basemaps) packages. If youâ€™d like to learn more about the functions used in this lesson you can use the help guides on their package websites.\n:::\n:::\n\n#### Check what days are available for the MCDWD L3 F3 product by going to this link: [LANCE NRT Primary Server](https://nrt3.modaps.eosdis.nasa.gov/archive/allData/61/MCDWD_L3_F3_NRT/) or [Secondary](https://nrt4.modaps.eosdis.nasa.gov/archive/allData/61/MCDWD_L3_F3_NRT).\n\nBased on availability, edit the year_day variable YYYY-DD. Example: '2022-01'\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#add the year and date you want to search for (YYYY-DD, 2022-01)\nyear_day <- '2024-023'\n```\n:::\n\n\n#### Determine tiles of interest:\n\n[MODIS NRT Tile Map](https://www.earthdata.nasa.gov/s3fs-public/2023-01/MCDWD_GlobalTileMapHoriz_Website_865x2250.jpg?VersionId=lOQ_j47U8T.j7UUqibD7SM63FVHjM_V5)\n\n<img src=\"https://www.earthdata.nasa.gov/s3fs-public/2023-01/MCDWD_GlobalTileMapHoriz_Website_865x2250.jpg?VersionId=lOQ_j47U8T.j7UUqibD7SM63FVHjM_V5\" alt=\"A global map with labeled tiles\" width=\"100%\"/>\n\nBased on availability, edit the tile_code variable:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#add tile code from the map above (written as h00v00)\ntile_code <- 'h05v05'\n```\n:::\n\n\nThis is the NRT Flood F3 (MCDWD_L3_F3) API URL:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Primary Server\n#API_URL <- paste0('https://nrt3.modaps.eosdis.nasa.gov/api/v2/content/details?products=MCDWD_L3_F3_NRT&archiveSets=61&temporalRanges=')\n\n# if the primary server is down, the secondary server may be available:\nAPI_URL <- paste0('https://nrt4.modaps.eosdis.nasa.gov/api/v2/content/details?products=MCDWD_L3_F3_NRT&archiveSets=61&temporalRanges=')\n```\n:::\n\n\nWe can combine the API URL above with the year_day provided and print the available datasets:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#pasting together URL and year_day\nurl <- paste0(API_URL, year_day)\nprint(url)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"https://nrt4.modaps.eosdis.nasa.gov/api/v2/content/details?products=MCDWD_L3_F3_NRT&archiveSets=61&temporalRanges=2024-023\"\n```\n:::\n:::\n\n\n## Loading the Data\n\nAccess the NASA Earthdata with the GET function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Make the GET request\nresponse <- httr::GET(url)\n```\n:::\n\n\nCheck the response status from the GET function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresponse\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nResponse [https://nrt4.modaps.eosdis.nasa.gov/api/v2/content/details?products=MCDWD_L3_F3_NRT&archiveSets=61&temporalRanges=2024-023]\n  Date: 2024-01-30 18:00\n  Status: 200\n  Content-Type: application/json;charset=UTF-8\n  Size: 113 kB\n```\n:::\n:::\n\n\nOut of the response from the server, we'll check if the response was a success with `if (http_status(response)$category == \"Success\")`. If this statement is true, then the content will be assigned to the variable `data` in JSON format, which is then parsed to a data frame using `data_parsed <- jsonlite::fromJSON(data)`. The data frame contains `data_parsed$content`, a column with content. We filter the content by tile code using the command `content_items <- data_parsed$content[grepl(tile_code, data_parsed$content$name, ignore.case = TRUE), ]` and add the results to a data frame.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Check the response status\nif (httr::http_status(response)$category == \"Success\") {\n  # Parse the response JSON\n  data <- httr::content(response, as = \"text\", encoding = \"UTF-8\")\n  data_parsed <- jsonlite::fromJSON(data)\n  #filter for the tile code\n  content_items <- data_parsed$content[grepl(tile_code, data_parsed$content$name, ignore.case = TRUE), ]\n} else {\n  print(\"Request failed with status code\", httr::http_status(response)$status_code)\n}\n\nprint(content_items)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n   archiveSets      cksum    collections               dataDay\n53          61 3182139075 modis-nrt-c6.1 2024-023 = 2024-01-23\n                                                                                         downloadsLink\n53 https://nrt4.modaps.eosdis.nasa.gov/api/v2/content/archives/MCDWD_L3_F3_NRT.A2024023.h05v05.061.tif\n       fileId                           md5sum      mtime\n53 1994021013 061b3cdc621ffad2cf9a24cbe239ab5b 1706065072\n                                      name        products resourceType\n53 MCDWD_L3_F3_NRT.A2024023.h05v05.061.tif MCDWD_L3_F3_NRT         File\n                                                              self   size\n53 /api/v2/content/details/MCDWD_L3_F3_NRT.A2024023.h05v05.061.tif 794917\n```\n:::\n:::\n\n\nSelect the URL from the 'downloadsLink' column in the content_items data frame:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndownload_link <- content_items$downloadsLink\nprint(download_link)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] \"https://nrt4.modaps.eosdis.nasa.gov/api/v2/content/archives/MCDWD_L3_F3_NRT.A2024023.h05v05.061.tif\"\n```\n:::\n:::\n\n\nUse the \"read_stars()\" function from the \"stars\" R Library to read the geoTiff raster.<br> The raster is assigned to the \"raster_df\" variable:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nraster_df <- stars::read_stars(download_link)\n```\n:::\n\n\nSet the Coordinate Reference System (CRS) to a new raster \"my_raster\" to plot it in a map. For example, Web Mercator EPSG:3857. Use the st_transform() function:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nraster_df <- sf::st_transform(raster_df, 3857)\n```\n:::\n\n\nNow the raster data should be stored as a variable \"my_raster\" with the CRS set to Web Mercator EPSG:3857\n\n## Visualizing NRT Flood Data\n\nPlot the raster to quickly view it:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot(raster_df, axes = TRUE)\n```\n\n::: {.cell-output-display}\n![](lance-modis-nrt-global-flood-mcdwd-f3_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n\n### Create NRT Flood Plot with Classification\n\nRefer to the [MODIS NRT Global Flood Product User Guide](https://www.earthdata.nasa.gov/s3fs-public/2023-01/MCDWD_UserGuide_RevC.pdf) for more information.\n\nNRT Flood data has 5 classifications:\n\n| Code | Definition          |\n|:----:|:--------------------|\n|  0   | No Water            |\n|  1   | Surface Water       |\n|  2   | Recurring flood[^3] |\n|  3   | Flood (unusual)     |\n| 255  | Insufficient data   |\n\n[^3]: Value 2 (Recurring flood) is not populated in the beta release.\n\nTo view the data in this classification, we'll need to create a classified legend; however, the NRT Flood data is stored in decimal numbers (aka floating-point). Create class breaks dividing the data by the following breaks, and corresponding colors and labels:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclass_breaks <- c(-Inf, 0.1, 1.1, 2.1, 3.1)\ncolors <- c( \"gray\", \"blue\", \"yellow\", \"red\")\n\nlabels = c(\"0: No Water\", \"1: Surface Water\", \"2: Recurring flood\", \"3: Flood (unusual)\")\n```\n:::\n\n\nAdd a title for the plot that includes the year, day of year, and tile code:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitle = paste(\"Near Real-Time Flood F3\", year_day, tile_code)\n```\n:::\n\n\n### Generate a basemap from Esri Imagery\n\nTo generate a basemap that shows the location of our raster, we must first create a bounding box to match `raster_df`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbbox <-  sf::st_bbox(raster_df)\n```\n:::\n\n\nThe `basemap_stars()` function from the `stars` library allows us to access Esri imagery layers. We choose \"world_imagery\" as our background and assign it to the object `bm_m`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbm_m <- basemaps::basemap_stars(bbox, map_service = \"esri\", map_type = \"world_imagery\")\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nLoading basemap 'world_imagery' from map service 'esri'...\n```\n:::\n:::\n\n\nThe `st_rgb` function lets us turn the RGB stars item into a single image\n\n\n::: {.cell}\n\n```{.r .cell-code}\nbm_m <- stars::st_rgb(bm_m)\n```\n:::\n\n\n### Plot basemap and NRT Flood data\n\nGenerate a plot from the tmap library using the `tm_shape()` function. We will plot the basemap and the raster_df items.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n## tmap mode set to \"plot\"\ntmap::tmap_mode(\"plot\")\n\n## tmap mode can also be set to \"view\"\n#tmap_mode(\"view\")\n\n#create an object the plots the basemap and the NRT flood raster\n#with the tmap library, call the tm_shape() function for the basemap\ntm_plot <- tmap::tm_shape(bm_m)+\n  tmap::tm_raster()+\n  #create a new tmap shape for the NRT flood raster with style as \"cat,\" meaning categorical.\n  tmap::tm_shape(raster_df, style=\"cat\")+\n  #add the classification styling to the raster\n  tmap::tm_raster( palette = c(colors),\n  title = title, \n  breaks = class_breaks,\n  labels = labels )+\n  #style the plot\n  tmap::tm_layout(legend.outside = TRUE) +\n  tmap::tm_graticules(lines=FALSE)\n```\n:::\n\n\nView the plot:\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntm_plot\n```\n\n::: {.cell-output-display}\n![](lance-modis-nrt-global-flood-mcdwd-f3_files/figure-html/unnamed-chunk-19-1.png){width=672}\n:::\n:::\n\n\n## In this Lesson, You Learned...\n\nCongratulations! Now you should be able to:\n\n-   Navigate the LANCE data website and determine what data is available.\n\n-   Select a tile and date to download NRT data.\n\n-   Create a GET HTTP request to download near-real-time data.\n\n-   Plot on a map and classify raster data to determine areas with unusual flooding.",
    "supporting": [
      "lance-modis-nrt-global-flood-mcdwd-f3_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}